#!/bin/bash

# Dump script - Update all dotfiles repositories
# Usage: ./dump [commit_message]

set -e  # Exit on error

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== Dotfiles Dump Script ===${NC}\n"

# Get commit message from argument or use default
COMMIT_MSG="${1:-Update dotfiles}"

# Directories
MAC_DOTFILES="$HOME/Mac-dotfiles"
LEADERKEY_DOTFILES="$HOME/leaderkey-dotfiles"
DOTFILES="$HOME/dotfiles"

# ========================================
# 1. Update Mac-dotfiles
# ========================================
echo -e "${GREEN}[1/3] Updating Mac-dotfiles...${NC}"
cd "$MAC_DOTFILES"

# Copy latest dotfiles from home directory
echo "  â†’ Copying dotfiles from home directory..."
cp ~/.zshrc .zshrc
cp ~/.gitconfig .gitconfig
cp ~/.aerospace.toml .aerospace.toml 2>/dev/null || true
cp ~/.zprofile .zprofile 2>/dev/null || true

# Copy .config directories
echo "  â†’ Copying .config directories..."
rsync -av --delete ~/.config/yazi/ .config/yazi/ 2>/dev/null || true
rsync -av --delete ~/.config/sketchybar/ .config/sketchybar/ 2>/dev/null || true
rsync -av --delete ~/.config/karabiner/ .config/karabiner/ 2>/dev/null || true
rsync -av --delete ~/.config/raycast/ .config/raycast/ 2>/dev/null || true

# Copy Leader Key config
echo "  â†’ Copying Leader Key config..."
mkdir -p "Library/Application Support/Leader Key"
cp "$HOME/Library/Application Support/Leader Key/config.json" "Library/Application Support/Leader Key/config.json" 2>/dev/null || true

# Generate Brewfile
echo "  â†’ Generating Brewfile..."
brew bundle dump --force --file=Brewfile

# Commit and push
if [[ -n $(git status -s) ]]; then
    git add .
    git commit -m "$(cat <<EOF
$COMMIT_MSG

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
    git push
    echo -e "  ${GREEN}âœ“ Mac-dotfiles updated and pushed${NC}"
else
    echo -e "  ${YELLOW}âŠ˜ No changes in Mac-dotfiles${NC}"
fi

# ========================================
# 2. Update leaderkey-dotfiles
# ========================================
echo -e "\n${GREEN}[2/3] Updating leaderkey-dotfiles...${NC}"
cd "$LEADERKEY_DOTFILES"

# Copy utility scripts from Mac-dotfiles
echo "  â†’ Copying utility scripts..."
cp "$MAC_DOTFILES/install.sh" ./install.sh 2>/dev/null || true
cp "$MAC_DOTFILES/README.md" ./README.md 2>/dev/null || true
cp "$MAC_DOTFILES/dump" ./dump 2>/dev/null || true
chmod +x ./install.sh 2>/dev/null || true
chmod +x ./dump 2>/dev/null || true

# Copy latest dotfiles from home directory
echo "  â†’ Copying dotfiles from home directory..."
cp ~/.zshrc .zshrc
cp ~/.gitconfig .gitconfig
cp ~/.aerospace.toml .aerospace.toml 2>/dev/null || true
cp ~/.zprofile .zprofile 2>/dev/null || true

# Copy .config directories
echo "  â†’ Copying .config directories..."
rsync -av --delete ~/.config/yazi/ .config/yazi/ 2>/dev/null || true
rsync -av --delete ~/.config/sketchybar/ .config/sketchybar/ 2>/dev/null || true
rsync -av --delete ~/.config/karabiner/ .config/karabiner/ 2>/dev/null || true
rsync -av --delete ~/.config/raycast/ .config/raycast/ 2>/dev/null || true

# Copy Leader Key config
echo "  â†’ Copying Leader Key config..."
mkdir -p "Library/Application Support/Leader Key"
cp "$HOME/Library/Application Support/Leader Key/config.json" "Library/Application Support/Leader Key/config.json" 2>/dev/null || true

# Generate Brewfile
echo "  â†’ Generating Brewfile..."
brew bundle dump --force --file=Brewfile

# Commit and push
if [[ -n $(git status -s) ]]; then
    git add .
    git commit -m "$(cat <<EOF
$COMMIT_MSG

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
    git push
    echo -e "  ${GREEN}âœ“ leaderkey-dotfiles updated and pushed${NC}"
else
    echo -e "  ${YELLOW}âŠ˜ No changes in leaderkey-dotfiles${NC}"
fi

# ========================================
# 3. Update dotfiles
# ========================================
echo -e "\n${GREEN}[3/3] Updating dotfiles...${NC}"
cd "$DOTFILES"

# Copy utility scripts from Mac-dotfiles
echo "  â†’ Copying utility scripts..."
cp "$MAC_DOTFILES/install.sh" ./install.sh 2>/dev/null || true
cp "$MAC_DOTFILES/README.md" ./README.md 2>/dev/null || true
cp "$MAC_DOTFILES/dump" ./dump 2>/dev/null || true
chmod +x ./install.sh 2>/dev/null || true
chmod +x ./dump 2>/dev/null || true

# Copy latest dotfiles from home directory
echo "  â†’ Copying dotfiles from home directory..."
cp ~/.zshrc .zshrc
cp ~/.gitconfig .gitconfig
cp ~/.aerospace.toml .aerospace.toml 2>/dev/null || true
cp ~/.zprofile .zprofile 2>/dev/null || true

# Copy .config directories
echo "  â†’ Copying .config directories..."
rsync -av --delete ~/.config/yazi/ .config/yazi/ 2>/dev/null || true
rsync -av --delete ~/.config/sketchybar/ .config/sketchybar/ 2>/dev/null || true
rsync -av --delete ~/.config/karabiner/ .config/karabiner/ 2>/dev/null || true
rsync -av --delete ~/.config/raycast/ .config/raycast/ 2>/dev/null || true

# Copy Leader Key config
echo "  â†’ Copying Leader Key config..."
mkdir -p "Library/Application Support/Leader Key"
cp "$HOME/Library/Application Support/Leader Key/config.json" "Library/Application Support/Leader Key/config.json" 2>/dev/null || true

# Generate Brewfile
echo "  â†’ Generating Brewfile..."
brew bundle dump --force --file=Brewfile

# Commit and push
if [[ -n $(git status -s) ]]; then
    git add .
    git commit -m "$(cat <<EOF
$COMMIT_MSG

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
    git push
    echo -e "  ${GREEN}âœ“ dotfiles updated and pushed${NC}"
else
    echo -e "  ${YELLOW}âŠ˜ No changes in dotfiles${NC}"
fi

# ========================================
# Done
# ========================================
echo -e "\n${BLUE}=== All repositories updated! ===${NC}"
echo -e "Repositories:"
echo -e "  â€¢ Mac-dotfiles:      https://github.com/Alebra88/Mac-dotfiles"
echo -e "  â€¢ leaderkey-dotfiles: https://github.com/Alebra88/leaderkey-dotfiles"
echo -e "  â€¢ dotfiles:          https://github.com/Alebra88/dotfiles"
